name: Update README with Spotify

on:
  schedule:
    - cron: "*/10 * * * *" # Every 10 minutes
  workflow_dispatch: # Manual trigger button
  push:
    branches: [main]

jobs:
  update-readme:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸµ Fetch current Spotify track
        id: spotify
        run: |
          echo "ğŸµ Fetching current track from Spotify API..."

          # Your ngrok URL - UPDATE THIS TO YOUR ACTUAL NGROK URL
          RESPONSE=$(curl -s "https://4f1223a444cb.ngrok-free.app/api/spotify" || echo '{"name":"Nothing playing","artist":"","album":"","isPlaying":false,"image":"https://i.scdn.co/image/ab67616d0000b273ec61804d798b2c42fe23f7c3"}')

          echo "API Response: $RESPONSE"

          # Extract data using jq
          TRACK_NAME=$(echo "$RESPONSE" | jq -r '.name // "Nothing playing"')
          ARTIST_NAME=$(echo "$RESPONSE" | jq -r '.artist // ""')
          IS_PLAYING=$(echo "$RESPONSE" | jq -r '.isPlaying // false')
          ALBUM_IMAGE=$(echo "$RESPONSE" | jq -r '.image // "https://i.scdn.co/image/ab67616d0000b273ec61804d798b2c42fe23f7c3"')

          echo "Track: $TRACK_NAME"
          echo "Artist: $ARTIST_NAME"
          echo "Playing: $IS_PLAYING"
          echo "Image: $ALBUM_IMAGE"

          # Set outputs for next step
          echo "track_name=$TRACK_NAME" >> $GITHUB_OUTPUT
          echo "artist_name=$ARTIST_NAME" >> $GITHUB_OUTPUT
          echo "is_playing=$IS_PLAYING" >> $GITHUB_OUTPUT
          echo "album_image=$ALBUM_IMAGE" >> $GITHUB_OUTPUT

      - name: ğŸ“ Update README
        run: |
          echo "ğŸ“ Updating README with enhanced track info..."

          if [ ! -f "update-readme.js" ]; then
            echo "âŒ update-readme.js not found!"
            exit 1
          fi

          node update-readme.js "${{ steps.spotify.outputs.track_name }}" "${{ steps.spotify.outputs.artist_name }}" "${{ steps.spotify.outputs.is_playing }}" "${{ steps.spotify.outputs.album_image }}"

      - name: ğŸš€ Commit and push changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action Bot"

          # Check if there are changes
          if git diff --quiet README.md; then
            echo "ğŸ”„ No changes to README"
            exit 0
          fi
